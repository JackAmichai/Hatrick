/**
 * Feature 20: Vulnerability Scanner Integration
 * Display scan targets, results, and vulnerability statistics
 */
import { useState, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Scan, 
  Server, 
  Globe, 
  Box,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Play,
  Clock,
  Shield,
  Activity,
  ChevronDown,
  ChevronRight,
  ExternalLink
} from 'lucide-react';
import type { 
  ScanTarget, 
  ScanResult, 
  Vulnerability, 
  VulnerabilityStats,
  VulnSeverity,
  ScanStatus 
} from '../../types/cyber';

interface VulnerabilityScannerProps {
  targets: ScanTarget[];
  results: ScanResult[];
  stats: VulnerabilityStats | null;
  onScanTarget?: (targetId: string) => void;
  onVulnerabilityClick?: (vulnId: string) => void;
}

const targetTypeIcons: Record<string, typeof Server> = {
  host: Server,
  network: Globe,
  application: Globe,
  container: Box,
};

const statusConfig: Record<ScanStatus, { color: string; icon: typeof Clock }> = {
  pending: { color: 'text-neutral-400 bg-neutral-500/20', icon: Clock },
  scanning: { color: 'text-cyan-400 bg-cyan-500/20', icon: Activity },
  completed: { color: 'text-green-400 bg-green-500/20', icon: CheckCircle },
  error: { color: 'text-red-400 bg-red-500/20', icon: XCircle },
};

const severityConfig: Record<VulnSeverity, { color: string; bg: string; priority: number }> = {
  critical: { color: 'text-red-400', bg: 'bg-red-500', priority: 5 },
  high: { color: 'text-orange-400', bg: 'bg-orange-500', priority: 4 },
  medium: { color: 'text-amber-400', bg: 'bg-amber-500', priority: 3 },
  low: { color: 'text-green-400', bg: 'bg-green-500', priority: 2 },
  info: { color: 'text-blue-400', bg: 'bg-blue-500', priority: 1 },
};

const SeverityBadge = ({ severity, count }: { severity: VulnSeverity; count: number }) => {
  const config = severityConfig[severity];
  return (
    <div className={`flex items-center gap-1 px-2 py-0.5 rounded text-xs ${config.bg}/20 ${config.color}`}>
      <span className="font-bold">{count}</span>
      <span className="uppercase">{severity}</span>
    </div>
  );
};

const TargetCard = ({ 
  target, 
  result,
  onScan 
}: { 
  target: ScanTarget; 
  result?: ScanResult;
  onScan?: () => void;
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const Icon = targetTypeIcons[target.target_type] || Server;
  const status = statusConfig[target.status];
  const StatusIcon = status.icon;
  
  return (
    <motion.div
      layout
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="p-4 bg-neutral-800/50 border border-neutral-700 rounded-lg"
    >
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-neutral-700/50 rounded-lg">
            <Icon className="w-5 h-5 text-cyan-400" />
          </div>
          <div>
            <h4 className="font-medium text-white">{target.name}</h4>
            <code className="text-xs text-neutral-400">{target.address}</code>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <span className={`flex items-center gap-1 px-2 py-0.5 rounded text-xs ${status.color}`}>
            <StatusIcon className="w-3 h-3" />
            {target.status}
          </span>
          {onScan && target.status !== 'scanning' && (
            <button
              onClick={onScan}
              className="p-1.5 bg-cyan-600/20 text-cyan-400 rounded hover:bg-cyan-600/30 transition-colors"
              title="Start scan"
            >
              <Play className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
      
      {/* Target info */}
      <div className="flex flex-wrap gap-2 mb-3">
        {target.os && (
          <span className="px-2 py-0.5 bg-neutral-700/50 text-neutral-300 rounded text-xs">
            {target.os}
          </span>
        )}
        {target.services.map(service => (
          <span key={service} className="px-2 py-0.5 bg-neutral-700/50 text-neutral-300 rounded text-xs">
            {service}
          </span>
        ))}
      </div>
      
      {/* Scan results summary */}
      {result && result.status === 'completed' && (
        <div
          className="pt-3 border-t border-neutral-700 cursor-pointer"
          onClick={() => setIsExpanded(!isExpanded)}
        >
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2">
              <AlertTriangle className="w-4 h-4 text-amber-400" />
              <span className="text-sm font-medium text-white">
                {result.summary.total} vulnerabilities found
              </span>
            </div>
            {isExpanded ? (
              <ChevronDown className="w-4 h-4 text-neutral-500" />
            ) : (
              <ChevronRight className="w-4 h-4 text-neutral-500" />
            )}
          </div>
          
          {/* Severity breakdown */}
          <div className="flex flex-wrap gap-2">
            {(['critical', 'high', 'medium', 'low', 'info'] as VulnSeverity[]).map(sev => {
              const count = result.summary[sev] || 0;
              if (count === 0) return null;
              return <SeverityBadge key={sev} severity={sev} count={count} />;
            })}
          </div>
          
          {/* Expanded vulnerability list */}
          <AnimatePresence>
            {isExpanded && result.vulnerabilities.length > 0 && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="mt-3 space-y-2"
              >
                {result.vulnerabilities
                  .sort((a, b) => severityConfig[b.severity].priority - severityConfig[a.severity].priority)
                  .map(vuln => (
                    <VulnerabilityRow key={vuln.id} vulnerability={vuln} />
                  ))}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      )}
      
      {/* Last scan info */}
      {target.last_scan && (
        <div className="mt-2 text-xs text-neutral-500">
          Last scan: {new Date(target.last_scan).toLocaleString()}
        </div>
      )}
    </motion.div>
  );
};

const VulnerabilityRow = ({ vulnerability }: { vulnerability: Vulnerability }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const config = severityConfig[vulnerability.severity];
  
  return (
    <motion.div
      layout
      className={`p-3 rounded-lg border-l-2 ${config.bg} bg-neutral-900/50 cursor-pointer`}
      onClick={() => setIsExpanded(!isExpanded)}
    >
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${config.bg}/20 ${config.color}`}>
              {vulnerability.severity.toUpperCase()}
            </span>
            <span className={`font-bold ${config.color}`}>
              {vulnerability.cvss_score.toFixed(1)}
            </span>
          </div>
          <h5 className="font-medium text-white text-sm">{vulnerability.name}</h5>
        </div>
        {isExpanded ? (
          <ChevronDown className="w-4 h-4 text-neutral-500" />
        ) : (
          <ChevronRight className="w-4 h-4 text-neutral-500" />
        )}
      </div>
      
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="mt-3 space-y-2 text-xs"
          >
            <p className="text-neutral-400">{vulnerability.description}</p>
            
            {vulnerability.port && (
              <div className="flex items-center gap-4 text-neutral-500">
                <span>Port: {vulnerability.port}/{vulnerability.protocol}</span>
                <span>Component: {vulnerability.affected_component}</span>
              </div>
            )}
            
            {vulnerability.cve_ids.length > 0 && (
              <div className="flex flex-wrap gap-1">
                {vulnerability.cve_ids.map(cve => (
                  <span key={cve} className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-xs font-mono">
                    {cve}
                  </span>
                ))}
              </div>
            )}
            
            <div className="p-2 bg-green-500/10 border border-green-500/20 rounded">
              <div className="flex items-center gap-1 mb-1">
                <Shield className="w-3 h-3 text-green-400" />
                <span className="text-green-400 font-medium">Solution</span>
              </div>
              <p className="text-neutral-300">{vulnerability.solution}</p>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

const StatsOverview = ({ stats }: { stats: VulnerabilityStats }) => (
  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div className="p-3 bg-neutral-800/50 border border-neutral-700 rounded-lg text-center">
      <div className="text-2xl font-bold text-white">{stats.total}</div>
      <div className="text-xs text-neutral-500">Total Vulnerabilities</div>
    </div>
    <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-center">
      <div className="text-2xl font-bold text-red-400">
        {stats.by_severity.critical + stats.by_severity.high}
      </div>
      <div className="text-xs text-neutral-500">Critical/High</div>
    </div>
    <div className="p-3 bg-neutral-800/50 border border-neutral-700 rounded-lg text-center">
      <div className="text-2xl font-bold text-cyan-400">{stats.with_cve}</div>
      <div className="text-xs text-neutral-500">With CVE</div>
    </div>
    <div className="p-3 bg-neutral-800/50 border border-neutral-700 rounded-lg text-center">
      <div className="text-2xl font-bold text-green-400">{stats.targets_scanned}</div>
      <div className="text-xs text-neutral-500">Targets Scanned</div>
    </div>
  </div>
);

export const VulnerabilityScanner = ({ 
  targets, 
  results, 
  stats,
  onScanTarget,
  onVulnerabilityClick 
}: VulnerabilityScannerProps) => {
  // Map results to targets
  const resultsMap = useMemo(() => {
    const map: Record<string, ScanResult> = {};
    results.forEach(r => {
      map[r.target_id] = r;
    });
    return map;
  }, [results]);
  
  return (
    <div className="p-6 bg-neutral-900/80 rounded-xl border border-neutral-700">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Scan className="w-5 h-5 text-cyan-400" />
          <h3 className="text-lg font-bold text-white">Vulnerability Scanner</h3>
        </div>
        
        <div className="flex items-center gap-2 text-sm">
          <span className="text-neutral-400">{targets.length} targets</span>
          <span className="text-neutral-400">|</span>
          <span className="text-neutral-400">{results.length} scans</span>
        </div>
      </div>
      
      {/* Stats overview */}
      {stats && <StatsOverview stats={stats} />}
      
      {/* Severity breakdown bar */}
      {stats && stats.total > 0 && (
        <div className="mb-4">
          <div className="flex h-3 rounded-full overflow-hidden">
            {(['critical', 'high', 'medium', 'low', 'info'] as VulnSeverity[]).map(sev => {
              const count = stats.by_severity[sev] || 0;
              const percent = (count / stats.total) * 100;
              if (percent === 0) return null;
              return (
                <div
                  key={sev}
                  className={`${severityConfig[sev].bg}`}
                  style={{ width: `${percent}%` }}
                  title={`${sev}: ${count} (${percent.toFixed(1)}%)`}
                />
              );
            })}
          </div>
          <div className="flex justify-between mt-1 text-xs text-neutral-500">
            <span>Critical/High: {(stats.by_severity.critical || 0) + (stats.by_severity.high || 0)}</span>
            <span>Medium: {stats.by_severity.medium || 0}</span>
            <span>Low/Info: {(stats.by_severity.low || 0) + (stats.by_severity.info || 0)}</span>
          </div>
        </div>
      )}
      
      {/* Targets list */}
      <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
        {targets.length > 0 ? (
          targets.map(target => (
            <TargetCard
              key={target.id}
              target={target}
              result={resultsMap[target.id]}
              onScan={onScanTarget ? () => onScanTarget(target.id) : undefined}
            />
          ))
        ) : (
          <div className="flex flex-col items-center justify-center py-12 text-neutral-500">
            <Server className="w-8 h-8 mb-2 opacity-50" />
            <p>No scan targets configured</p>
            <p className="text-xs mt-1">Add targets to begin vulnerability scanning</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default VulnerabilityScanner;
